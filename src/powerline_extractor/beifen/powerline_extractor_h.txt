#ifndef POWERLINE_EXTRACTOR_H
#define POWERLINE_EXTRACTOR_H

#include <ros/ros.h>
#include <sensor_msgs/PointCloud2.h>
#include <matio.h>
#include <string>
#include <pcl/filters/voxel_grid.h>
#include <pcl/kdtree/kdtree_flann.h>
#include <pcl/point_cloud.h>
#include <pcl/point_types.h>
#include <pcl_conversions/pcl_conversions.h>
#include <pcl/common/common.h>
#include <pcl/io/pcd_io.h>

#include <pcl/segmentation/extract_clusters.h>

#include <Eigen/Dense>

class PowerlineExtractor {
public:
    PowerlineExtractor();
    ~PowerlineExtractor();
    void processAndPublishPowerlines();

private:
    // 加载.mat文件和基本处理
    void checkParameters();
    bool loadMatFile(const std::string& file_path);
    void doubleToPointCloud();
    
    // 电力线提取相关方法
    void extractNonGroundPoints();
    void extractPowerlinePoints();
    void getPCA(const pcl::PointCloud<pcl::PointXYZI>::Ptr& cloud, 
               pcl::PointCloud<pcl::PointXYZI>::Ptr& powerlinePoints);
    void clusterPowerlines(const pcl::PointCloud<pcl::PointXYZI>::Ptr& candidateCloud,
                pcl::PointCloud<pcl::PointXYZI>::Ptr& filteredCloud);
    
    // 其他工具方法
    void centerPointCloud(pcl::PointCloud<pcl::PointXYZI>::Ptr& cloud);
    void downsamplePointCloud(const pcl::PointCloud<pcl::PointXYZI>::Ptr& input, 
                             pcl::PointCloud<pcl::PointXYZI>::Ptr& output);
    void adjustPointCloudOrigin(pcl::PointCloud<pcl::PointXYZI>::Ptr& cloud);

    // ROS相关
    ros::NodeHandle nh_;
    ros::Publisher original_cloud_pub_;
    ros::Publisher non_ground_pub_;
    ros::Publisher powerline_pub_;

    ros::Publisher clustered_powerline_pub_;
    
    // 参数
    double scale_factor_;
    std::string mat_file_path_;
    double voxel_size_;
    double pca_radius_;
    double angle_threshold_;
    double linearity_threshold_;

    double cluster_tolerance_;
    int min_cluster_size_;
    int max_cluster_size_;
    
    // 数据
    double** point_cloud_data_;
    size_t num_points_;
    
    // 点云对象
    pcl::PointCloud<pcl::PointXYZI>::Ptr original_cloud_;
    pcl::PointCloud<pcl::PointXYZI>::Ptr non_ground_cloud_;
    pcl::PointCloud<pcl::PointXYZI>::Ptr powerline_cloud_;

    pcl::PointCloud<pcl::PointXYZI>::Ptr clustered_powerline_cloud_;
    
    // 滤波器
    pcl::VoxelGrid<pcl::PointXYZI> down_size_filter_;
};

#endif // POWERLINE_EXTRACTOR_H